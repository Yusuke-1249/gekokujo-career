# Google Apps Script デプロイ手順書

## 1. Google Apps Script プロジェクトの作成

1. [Google Apps Script](https://script.google.com/) にアクセス
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を「下剋上キャリア_フォーム処理」に変更

## 2. コードの実装

1. デフォルトの `コード.gs` を削除
2. 「ファイル」→「名前を変更」→ `Code.gs` に変更
3. `/gas/Code.gs` の内容をすべてコピーして貼り付け

## 3. スプレッドシートの権限設定

1. [スプレッドシート](https://docs.google.com/spreadsheets/d/1vf1RlD1seUyKhNsOAYLuaKhp43mL7QYXpQBsFn8Xv6g/edit)を開く
2. 右上の「共有」をクリック
3. `info@apoial.com` に編集権限を付与

## 4. GASのデプロイ

1. GASエディタで「デプロイ」→「新しいデプロイ」をクリック
2. 設定：
   - **種類**: ウェブアプリ
   - **説明**: 下剋上キャリア フォーム処理 v1
   - **次のユーザーとして実行**: 自分
   - **アクセスできるユーザー**: 全員
3. 「デプロイ」をクリック
4. **ウェブアプリのURL**をコピー（重要！）

## 5. 権限の承認

初回デプロイ時：
1. 「アクセスを承認」をクリック
2. Googleアカウントを選択
3. 「詳細」→「下剋上キャリア_フォーム処理（安全ではないページ）に移動」
4. 必要な権限を確認して「許可」

## 6. Next.js側の環境変数設定

### ローカル環境（.env.local）
```bash
NEXT_PUBLIC_GAS_URL=https://script.google.com/macros/s/[デプロイID]/exec
```

### Vercel環境
1. Vercelダッシュボードにログイン
2. プロジェクトの「Settings」→「Environment Variables」
3. 以下を追加：
   - **Key**: `NEXT_PUBLIC_GAS_URL`
   - **Value**: GASのウェブアプリURL
   - **Environment**: Production, Preview, Development すべてにチェック

## 7. テスト方法

### GAS側でテスト
1. GASエディタで `testPost()` 関数を選択
2. 「実行」をクリック
3. 実行ログを確認
4. スプレッドシートにテストデータが追加されているか確認

### ローカル環境でテスト
```bash
npm run dev
```
1. http://localhost:3000 にアクセス
2. フォームに入力して送信
3. スプレッドシートとメールを確認

## 8. トラブルシューティング

### よくある問題と解決方法

#### 1. CORS エラー
- **症状**: フォーム送信時に CORS エラー
- **解決**: GASのデプロイ設定で「全員」がアクセスできるようになっているか確認

#### 2. 401 Unauthorized
- **症状**: 認証エラー
- **解決**: GASの実行ユーザーが「自分」になっているか確認

#### 3. メールが送信されない
- **症状**: スプレッドシートには記録されるがメールが来ない
- **原因**: Gmail APIの制限（1日の送信上限）
- **解決**: 24時間待つか、別のGoogleアカウントでデプロイ

#### 4. ひらがながカタカナに変換されない
- **症状**: カナ欄がひらがなのまま
- **確認**: `hiraganaToKatakana` 関数が正しく動作しているか

## 9. 本番デプロイチェックリスト

- [ ] GASのコードが最新版になっている
- [ ] スプレッドシートの権限設定が完了
- [ ] GASのデプロイが完了
- [ ] 環境変数が設定されている（ローカル）
- [ ] 環境変数が設定されている（Vercel）
- [ ] テスト送信が成功
- [ ] メール送信が確認できた
- [ ] スプレッドシートへの記録が確認できた

## 10. 更新時の手順

GASのコードを更新した場合：
1. GASエディタで変更を保存
2. 「デプロイ」→「デプロイを管理」
3. 鉛筆アイコン（編集）をクリック
4. 「バージョン」→「新バージョン」
5. 説明を入力（例: "メールテンプレート更新"）
6. 「デプロイ」をクリック

**注意**: URLは変わらないので、環境変数の更新は不要